/*
 * Nextflow Configuration for VCA Pipeline
 * Variant Calling Analysis for Circulating Tumor DNA
 * 
 * Author: Luis Aguilera
 */

// Pipeline metadata
manifest {
    name            = 'vca-pipeline'
    author          = 'Luis Aguilera'
    homePage        = 'https://github.com/luisub/NGS_biomarker_discovery_toolkit'
    description     = 'Variant Calling Analysis Pipeline for Circulating Tumor DNA'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=23.04.0'
    version         = '1.2.0'
}

// =============================================================================
// Plugins
// =============================================================================
plugins {
    id 'nf-schema@2.1.1'  // Schema validation for parameters and samplesheets
}

// =============================================================================
// Validation Settings (nf-schema)
// =============================================================================
validation {
    // Enable parameter validation
    defaultIgnoreParams = ['genomes']
    help {
        enabled = true
        showHidden = false
    }
    summary {
        beforeText = """
=======================================================
  VCA Pipeline v${manifest.version}
  Variant Calling Analysis for Circulating Tumor DNA
=======================================================
"""
    }
}

// =============================================================================
// Default Parameters
// =============================================================================
params {
    // Input/Output
    input                   = null          // Samplesheet CSV path
    outdir                  = 'results'     // Output directory
    
    // Reference genome
    genome                  = 'GRCh38'
    genome_fasta            = null          // Path to reference FASTA
    genome_fasta_fai        = null          // Path to reference FASTA index
    bwa_index               = null          // Path to BWA index directory
    
    // Optional: dbSNP for variant annotation
    dbsnp                   = null          // Path to dbSNP VCF
    dbsnp_tbi               = null          // Path to dbSNP VCF index
    
    // SnpEff database
    snpeff_db               = 'GRCh38.p14'
    snpeff_cache            = null          // Path to SnpEff cache directory
    
    // Target region (optional - for targeted sequencing)
    target_bed              = null          // BED file with target regions
    target_gene             = 'KRAS'
    target_chromosome       = 'chr12'
    target_start            = 25200000
    target_end              = 25250000
    
    // Processing parameters
    threads                 = 4
    
    // Quality filters
    min_base_quality        = 30
    min_mapping_quality     = 20
    min_read_depth          = 20
    min_allele_frequency    = 0.01          // 1% VAF threshold for ctDNA
    max_strand_bias         = null          // Strand bias threshold (null = no filter)
    
    // Read trimming (fastp)
    adapter_fasta           = null          // Custom adapters FASTA
    trim_front              = 0
    trim_tail               = 0
    min_read_length         = 50
    
    // Germline filtering
    gnomad_vcf              = null          // Path to gnomAD VCF for germline filtering
    gnomad_tbi              = null          // Path to gnomAD VCF index
    panel_of_normals        = null          // Path to Panel of Normals VCF
    max_population_af       = 0.01          // Max population AF to consider somatic
    
    // Coverage analysis
    min_target_coverage     = 500           // Minimum required coverage for ctDNA
    
    // Analysis mode
    whole_genome            = false         // If true, analyze whole genome (not just target)
    
    // Skip steps
    skip_fastqc             = false
    skip_trimming           = false
    skip_markdup            = false
    skip_annotation         = false
    skip_multiqc            = false
    skip_coverage           = false         // Skip mosdepth coverage analysis
    skip_germline_filter    = true          // Skip germline filtering (requires gnomad_vcf)
    skip_normalization      = false         // Skip variant normalization
    skip_bqsr               = false         // Skip base quality score recalibration (LoFreq viterbi)
    
    // Intermediate file options
    save_bqsr_bam           = false         // Save BQSR-recalibrated BAM files
    
    // Resource limits
    max_memory              = '128.GB'
    max_cpus                = 16
    max_time                = '240.h'
    
    // Boilerplate options
    help                    = false
    version                 = false
    publish_dir_mode        = 'copy'
    monochrome_logs         = false
    tracedir                = "${params.outdir}/pipeline_info"
}

// =============================================================================
// Execution Profiles
// =============================================================================
profiles {
    
    // Local execution with Conda
    standard {
        process.executor = 'local'
        conda.enabled = true
    }
    
    // Singularity profile (recommended for HPC)
    singularity {
        singularity.enabled     = true
        singularity.autoMounts  = true
        singularity.cacheDir    = "${projectDir}/singularity_cache"
        docker.enabled          = false
        podman.enabled          = false
        shifter.enabled         = false
        charliecloud.enabled    = false
    }
    
    // Docker profile (for local development)
    docker {
        docker.enabled          = true
        docker.userEmulation    = true
        singularity.enabled     = false
        podman.enabled          = false
        shifter.enabled         = false
        charliecloud.enabled    = false
    }
    
    // SLURM cluster profile
    slurm {
        process.executor        = 'slurm'
        process.queue           = 'normal'
        process.clusterOptions  = '--account=myaccount'
        
        // Default resources per process
        process.cpus            = 4
        process.memory          = '16 GB'
        process.time            = '4h'
    }
    
    // PBS/Torque cluster profile
    pbs {
        process.executor        = 'pbs'
        process.queue           = 'batch'
    }
    
    // AWS Batch profile
    awsbatch {
        process.executor        = 'awsbatch'
        process.queue           = 'my-batch-queue'
        aws.region              = 'us-east-1'
        aws.batch.cliPath       = '/home/ec2-user/miniconda/bin/aws'
    }
    
    // Test profile with minimal resources
    test {
        params.max_cpus         = 2
        params.max_memory       = '6.GB'
        params.max_time         = '1.h'
        params.input            = "${projectDir}/test/test_samplesheet.csv"
    }
    
    // Debug profile
    debug {
        process.beforeScript    = 'echo $HOSTNAME'
        cleanup                 = false
    }
}

// =============================================================================
// Process-specific Configuration
// =============================================================================
process {
    
    // Default container for all processes
    container = 'quay.io/biocontainers/mulled-v2-cf0123ef83b3c38c13e3b0696a3f285d3f20f15b:64aad4a4e144878400649e71f42105311be7ed87-0'
    
    // Error handling
    errorStrategy = { task.exitStatus in [140,143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries    = 2
    maxErrors     = '-1'
    
    // Resource labels
    withLabel: process_single {
        cpus   = { 1 }
        memory = { 4.GB * task.attempt }
        time   = { 2.h * task.attempt }
    }
    
    withLabel: process_low {
        cpus   = { 2 * task.attempt }
        memory = { 8.GB * task.attempt }
        time   = { 4.h * task.attempt }
    }
    
    withLabel: process_medium {
        cpus   = { 4 * task.attempt }
        memory = { 16.GB * task.attempt }
        time   = { 8.h * task.attempt }
    }
    
    withLabel: process_high {
        cpus   = { 8 * task.attempt }
        memory = { 32.GB * task.attempt }
        time   = { 16.h * task.attempt }
    }
    
    withLabel: process_long {
        time   = { 24.h * task.attempt }
    }
    
    // Process-specific containers
    withName: 'FASTQC' {
        container = 'quay.io/biocontainers/fastqc:0.12.1--hdfd78af_0'
    }
    
    withName: 'FASTP' {
        container = 'quay.io/biocontainers/fastp:0.23.4--hadf994f_2'
    }
    
    withName: 'BWA_INDEX' {
        container = 'quay.io/biocontainers/bwa:0.7.18--he4a0461_0'
    }
    
    withName: 'BWA_MEM' {
        container = 'quay.io/biocontainers/mulled-v2-fe8faa35dbf6dc65a0f7f5d4ea12e31a79f73e40:a34558545ae1413d94bde4578787ebef08027945-0'
    }
    
    withName: 'SAMTOOLS_.*' {
        container = 'quay.io/biocontainers/samtools:1.19--h50ea8bc_0'
    }
    
    withName: 'LOFREQ_CALL' {
        // Mulled container with lofreq + samtools + htslib
        container = 'quay.io/biocontainers/mulled-v2-4f8e2ed02c274b738b62a4e99cb6e02c84be1a6c:8d8db227fb4e07410c6e7fe07be0eae17b859ee4-0'
    }
    
    withName: 'SNPEFF_ANNOTATE' {
        container = 'quay.io/biocontainers/snpeff:5.2--hdfd78af_0'
    }
    
    withName: 'BCFTOOLS_.*' {
        container = 'quay.io/biocontainers/bcftools:1.19--h8b25389_0'
    }
    
    withName: 'MOSDEPTH' {
        container = 'quay.io/biocontainers/mosdepth:0.3.5--hd299d5a_0'
    }
    
    withName: 'PICARD_.*' {
        container = 'quay.io/biocontainers/picard:3.1.1--hdfd78af_0'
    }
    
    withName: 'MULTIQC' {
        container = 'quay.io/biocontainers/multiqc:1.21--pyhdfd78af_0'
    }
}

// =============================================================================
// Reporting & Timeline
// =============================================================================
timeline {
    enabled = true
    file    = "${params.tracedir}/execution_timeline.html"
}

report {
    enabled = true
    file    = "${params.tracedir}/execution_report.html"
}

trace {
    enabled = true
    file    = "${params.tracedir}/execution_trace.txt"
    fields  = 'task_id,hash,native_id,name,status,exit,submit,duration,realtime,%cpu,peak_rss,peak_vmem'
}

dag {
    enabled = true
    file    = "${params.tracedir}/pipeline_dag.svg"
}

// =============================================================================
// Singularity-specific Settings
// =============================================================================
singularity {
    runOptions = "--bind ${projectDir}:${projectDir}"
}

// =============================================================================
// Function to check resources
// =============================================================================
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "   ### ERROR ### Max memory '${params.max_memory}' is not valid! Using default value"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "   ### ERROR ### Max time '${params.max_time}' is not valid! Using default value"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min( obj, params.max_cpus as int )
        } catch (all) {
            println "   ### ERROR ### Max cpus '${params.max_cpus}' is not valid! Using default value"
            return obj
        }
    }
}

// =============================================================================
// Include Gene Profiles
// =============================================================================
includeConfig 'conf/gene_profiles.config'
